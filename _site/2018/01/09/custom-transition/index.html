<h1 id="история-вью-контроллера-который-хотел-показываться-красиво">ИСТОРИЯ ВЬЮ-КОНТРОЛЛЕРА, КОТОРЫЙ ХОТЕЛ ПОКАЗЫВАТЬСЯ КРАСИВО</h1>

<p>Жил был скромный вью контроллер <em>VCYellow</em>. И не было у него ни картинки, ни текста, ни даже малюсенькой бизнес логики. Жил он обычной вью-контроллероской жизнью.</p>
<cut />

<p>Его товарищ вью-контроллер <em>VCMain</em> иногда презентовал его миру:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">VCMain</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
<span class="o">...</span>
	<span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">onBtnTapMeTapped</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">vcYellow</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">storyboard</span><span class="o">!.</span><span class="nf">instantiateViewController</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="s">"VCYellow"</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">VCYellow</span>
        <span class="n">vcYellow</span><span class="o">.</span><span class="n">startFrame</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">btnTapMe</span><span class="o">.</span><span class="n">frame</span><span class="p">;</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="n">vcYellow</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>А <em>VCYellow</em> в свою очередь скрывался при помощи единственной кнопки “X”, которой он, кстати говоря, очень гордился:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">VCYellow</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
<span class="o">...</span>
	<span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">onBtnCloseTapped</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">dismiss</span><span class="p">(</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>И выглядело это не то чтобы плохо, но скучно и обыденно:</p>

<p><img src="https://habrastorage.org/webt/fb/lf/op/fblfopvr4h0lp2dyltbjqhled64.gif" alt="" /></p>

<p>Но была у нашего героя мечта научиться показываться и скрываться диковенным образом. Да таким, чтобы можно было эту красоту менять потом по праздникам или просто в честь хорошего настроения.</p>

<p><img src="https://habrastorage.org/webt/ow/f1/jd/owf1jdk2uqqufbr_fzuntpwlovk.gif" alt="" /></p>

<p>Шли года… и так и осталась бы мечта мечтой, если бы не узнал <em>VCYellow</em> о магии под названием:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UIViewControllerTransitioningDelegate
</code></pre></div></div>
<p>А сила этой магии в том, что даёт она возможность подсунуть соответствующий аниматор для показа и для скрытия вью-контроллера. Как раз то, о чём мечтал наш контроллер.
Почитал он в <a href="https://developer.apple.com/documentation/uikit/uiviewcontrollertransitioningdelegate">древних свитках</a> как использовать заклятие и начал готовиться.
Записал себе шпаргалку с самим заклинаниеми, чтобы не забыть:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">VCYellow</span><span class="p">:</span> <span class="kt">UIViewControllerTransitioningDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">animationController</span><span class="p">(</span><span class="n">forPresented</span> <span class="nv">presented</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="nv">presenting</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="nv">source</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UIViewControllerAnimatedTransitioning</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnimatorPresent</span><span class="p">(</span><span class="nv">startFrame</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">startFrame</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">animationController</span><span class="p">(</span><span class="n">forDismissed</span> <span class="nv">dismissed</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UIViewControllerAnimatedTransitioning</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnimatorDismiss</span><span class="p">(</span><span class="nv">endFrame</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">startFrame</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>В ней он тщательно расписал, что при открытии нужно использовать аниматор <em>AnimatorPresent</em>, а при закрытии <em>AnimatorDismiss</em>.
Ну и в качестве помощи обоим аниматором было решено передать фрейм главной кнопки из <em>VCMain</em></p>

<p>А потом и сам морально настроился. Потому как без правильного настроя, как известно, никакая магия не работает:</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">modalPresentationStyle</span> <span class="o">=</span> <span class="o">.</span><span class="n">custom</span>
        <span class="k">self</span><span class="o">.</span><span class="n">transitioningDelegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>Попросил он своего друга VCMain презентануть себя ещё разок, что бы проверить как магия сработает и… сработала она никак…
Оказалось, что AnimatorPresent и AnimatorDismiss сами собой не появляются, а следовательно магический сеанс не состоялся.</p>

<p>Останавливаться было уже поздно и наш герой решил создать необходимые аниматоры. Поковырялся в нужном разделе <a href="https://developer.apple.com/documentation/uikit/uiviewcontrolleranimatedtransitioning">древних свитков</a> и узнал, что</p>

<p>во-первых надо задать время, отведённое на анимацию:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">transitionDuration</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimeInterval</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.3</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>а во-вторых обозначить саму анимацию:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="kd">func</span> <span class="nf">animateTransition</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//1</span>
		<span class="k">guard</span> <span class="k">let</span> <span class="nv">vcTo</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="nf">viewController</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">to</span><span class="p">),</span>
            <span class="k">let</span> <span class="nv">snapshot</span> <span class="o">=</span> <span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="nf">snapshotView</span><span class="p">(</span><span class="nv">afterScreenUpdates</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="c1">//2</span>
		<span class="k">let</span> <span class="nv">vContainer</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="n">containerView</span>
        
        <span class="c1">//3</span>
		<span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        
        <span class="c1">//4</span>
		<span class="n">snapshot</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">startFrame</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
        
        
        <span class="kt">UIView</span><span class="o">.</span><span class="nf">animate</span><span class="p">(</span><span class="nv">withDuration</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                       <span class="nv">animations</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">//5</span>
			<span class="n">snapshot</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">transitionContext</span><span class="o">.</span><span class="nf">finalFrame</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">vcTo</span><span class="p">))</span>
        <span class="p">},</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="n">success</span> <span class="k">in</span>
            <span class="c1">//6</span>
			<span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="n">snapshot</span><span class="o">.</span><span class="nf">removeFromSuperview</span><span class="p">()</span>
            <span class="n">transitionContext</span><span class="o">.</span><span class="nf">completeTransition</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>1) вытащить презентуемый вью-контроллер(в нашем случаей VCYellow) и сфоткать его. Фотка нужна для 
крутой анимации.</p>

<p>2) Получить вьюшку, на которой будет происходить анимационное колдунство. 
Назовем её контекст.</p>

<p>3) Нацепить вьюху конечного контроллера на контекст и скрыть её. Показать 
её было решено после того как закончится анимация</p>

<p>4) Подготовить фотку для анимации. Сжать до начальных размеров и кинуть на контекст.</p>

<p>5) Расщеперить фотку на весь экран, тем самым анимировав процесс презентации</p>

<p>6) После окончания анимации показать настоящую вьюху конечного контроллера, 
избавиться от фотки и сообщить, что действо окончено.</p>

<p>В результате вышел вот такой аниматор для показа:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">class</span> <span class="kt">AnimatorPresent</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">UIViewControllerAnimatedTransitioning</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">startFrame</span><span class="p">:</span> <span class="kt">CGRect</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">startFrame</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">startFrame</span> <span class="o">=</span> <span class="n">startFrame</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">transitionDuration</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimeInterval</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.3</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">animateTransition</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">vcTo</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="nf">viewController</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">to</span><span class="p">),</span>
            <span class="k">let</span> <span class="nv">snapshot</span> <span class="o">=</span> <span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="nf">snapshotView</span><span class="p">(</span><span class="nv">afterScreenUpdates</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">vContainer</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="n">containerView</span>
        
        <span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        
        <span class="n">snapshot</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">startFrame</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
        
        
        <span class="kt">UIView</span><span class="o">.</span><span class="nf">animate</span><span class="p">(</span><span class="nv">withDuration</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                       <span class="nv">animations</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">snapshot</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">transitionContext</span><span class="o">.</span><span class="nf">finalFrame</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">vcTo</span><span class="p">))</span>
        <span class="p">},</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="n">success</span> <span class="k">in</span>
            <span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="n">snapshot</span><span class="o">.</span><span class="nf">removeFromSuperview</span><span class="p">()</span>
            <span class="n">transitionContext</span><span class="o">.</span><span class="nf">completeTransition</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>А после этого несложно было описать аниматор для скрывания, который делает примерно то же самое, но наоборот:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">class</span> <span class="kt">AnimatorDismiss</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">UIViewControllerAnimatedTransitioning</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">endFrame</span><span class="p">:</span> <span class="kt">CGRect</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">endFrame</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">endFrame</span> <span class="o">=</span> <span class="n">endFrame</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">transitionDuration</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimeInterval</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.3</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">animateTransition</span><span class="p">(</span><span class="n">using</span> <span class="nv">transitionContext</span><span class="p">:</span> <span class="kt">UIViewControllerContextTransitioning</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">vcTo</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="nf">viewController</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">to</span><span class="p">),</span>
            <span class="k">let</span> <span class="nv">vcFrom</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="nf">viewController</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">from</span><span class="p">),</span>
            <span class="k">let</span> <span class="nv">snapshot</span> <span class="o">=</span> <span class="n">vcFrom</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="nf">snapshotView</span><span class="p">(</span><span class="nv">afterScreenUpdates</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">vContainer</span> <span class="o">=</span> <span class="n">transitionContext</span><span class="o">.</span><span class="n">containerView</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">vcTo</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">vContainer</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
        
        <span class="n">vcFrom</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">true</span>

        <span class="kt">UIView</span><span class="o">.</span><span class="nf">animate</span><span class="p">(</span><span class="nv">withDuration</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                       <span class="nv">animations</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">snapshot</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">endFrame</span>
        <span class="p">},</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="n">success</span> <span class="k">in</span>
            <span class="n">transitionContext</span><span class="o">.</span><span class="nf">completeTransition</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Закончив все доделки, VCYellow опять попросил своего друга VCMain презентовать себя и о чудо!</p>

<p><img src="https://habrastorage.org/webt/ow/f1/jd/owf1jdk2uqqufbr_fzuntpwlovk.gif" alt="" /></p>

<p>Магия сработала! Мечта VCYellow сбылась и жизнь его никогда не будет прежней :)</p>

<p>Конец.</p>

<p>Проект-пример можно скачать <a href="https://github.com/funkydevil/customTransition">тут</a></p>

<p>Статья, которую я использовал для вдохновения находится <a href="https://www.raywenderlich.com/322-custom-uiviewcontroller-transitions-getting-started">тут</a></p>

